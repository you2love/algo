<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperLogLog - ç®—æ³•å­¦ä¹ æŒ‡å—</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .math-formula {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px 20px;
            margin: 20px 0;
            font-family: 'Times New Roman', serif;
            font-size: 1.1em;
        }
        
        .step-diagram {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 30px 0;
            padding: 20px;
            background: #f0f4f8;
            border-radius: 10px;
        }
        
        .step-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 150px;
        }
        
        .step-box h4 {
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .arrow {
            font-size: 24px;
            color: #2c3e50;
        }
        
        .register-visual {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin: 20px 0;
        }
        
        .register {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 5px;
            text-align: center;
            border-radius: 4px;
            font-size: 0.85em;
            transition: transform 0.3s ease;
        }
        
        .register:hover {
            transform: scale(1.1);
        }
        
        .register.highlight {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .comparison-table th {
            background: #3498db;
            color: white;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .principle-box {
            background: white;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .principle-box h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .hash-demo {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            margin: 15px 0;
        }
        
        .highlight-text {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
    <link rel="stylesheet" href="../lib/prism/prism-tomorrow.min.css">
    <link rel="stylesheet" href="../lib/prism/prism-line-numbers.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">AlgoLearn</h1>
            <ul class="nav-links">
                <li><a href="../index.html">é¦–é¡µ</a></li>
                <li><a href="../index.html#algorithms">ç®—æ³•åˆ†ç±»</a></li>
                <li><a href="../index.html#practice">åœ¨çº¿ç»ƒä¹ </a></li>
            </ul>
        </div>
    </nav>

    <section class="algorithm-detail">
        <div class="container">
            <a href="../index.html#algorithms" class="back-link">â† è¿”å›ç®—æ³•åˆ†ç±»</a>
            <h2>HyperLogLog - æ¦‚ç‡åŸºæ•°ä¼°è®¡</h2>
            
            <div class="algorithm-content">
                <h3>ä»€ä¹ˆæ˜¯HyperLogLogï¼Ÿ</h3>
                <p>
                    <strong>HyperLogLog (HLL)</strong> æ˜¯ä¸€ç§æ¦‚ç‡æ€§æ•°æ®ç»“æ„ï¼Œç”¨äºé«˜æ•ˆåœ°ä¼°è®¡é›†åˆä¸­ä¸åŒå…ƒç´ çš„æ•°é‡ï¼ˆåŸºæ•°ï¼‰ã€‚
                    ç”± Philippe Flajolet ç­‰äººåœ¨ 2007 å¹´æå‡ºï¼Œæ˜¯è‘—åçš„ <strong>LogLog</strong> ç®—æ³•çš„æ”¹è¿›ç‰ˆæœ¬ã€‚
                </p>
                <p>
                    HyperLogLog çš„ç¥å¥‡ä¹‹å¤„åœ¨äºï¼š<span class="highlight-text">ä»…ç”¨ 12KB çš„å†…å­˜</span>ï¼Œå°±å¯ä»¥ä¼°è®¡æœ€å¤š <span class="highlight-text">2^64 ä¸ªä¸åŒå…ƒç´ </span>ï¼Œ
                    è¯¯å·®ç‡ä»…ä¸º <span class="highlight-text">0.81%</span>ã€‚
                </p>
            </div>

            <div class="complexity">
                <div class="complexity-item">
                    <h4>ç©ºé—´å¤æ‚åº¦</h4>
                    <p>O(1) - å›ºå®šçº¦12KB</p>
                </div>
                <div class="complexity-item">
                    <h4>æ—¶é—´å¤æ‚åº¦</h4>
                    <p>O(1) - æ¯å…ƒç´ æ“ä½œ</p>
                </div>
                <div class="complexity-item">
                    <h4>æ ‡å‡†è¯¯å·®</h4>
                    <p>â‰ˆ 0.81%</p>
                </div>
            </div>

            <h2>æ ¸å¿ƒåŸç†ï¼šæ¦‚ç‡ä¼°è®¡</h2>
            
            <div class="principle-box">
                <h4>ğŸ² æŠ›ç¡¬å¸çš„å¯ç¤º</h4>
                <p>
                    HyperLogLog çš„æ ¸å¿ƒæ€æƒ³å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„æ¦‚ç‡æ¸¸æˆæ¥è§£é‡Šï¼š
                </p>
                <div class="math-formula">
                    <p><strong>é—®é¢˜ï¼š</strong>è¿ç»­æŠ›ç¡¬å¸å¤šå°‘æ¬¡æ‰èƒ½ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿ç»­ k ä¸ªæ­£é¢ï¼Ÿ</p>
                    <p><strong>ç­”æ¡ˆï¼š</strong>å¹³å‡éœ€è¦ 2^k æ¬¡æŠ›æ·</p>
                </div>
                <p>
                    ä¾‹å¦‚ï¼šçœ‹åˆ° 3 ä¸ªè¿ç»­æ­£é¢çš„å¹³å‡æ¬¡æ•°æ˜¯ 2Â³ = 8 æ¬¡
                </p>
                <p>
                    <strong>é€†å‘æ€è€ƒï¼š</strong>å¦‚æœæˆ‘ä»¬çœ‹åˆ° k ä¸ªè¿ç»­æ­£é¢ï¼Œå¯ä»¥æ¨æ–­å¤§çº¦æŠ›äº† 2^k æ¬¡
                </p>
            </div>

            <h3>åº”ç”¨åˆ°åŸºæ•°ä¼°è®¡</h3>
            <div class="algorithm-content">
                <p>
                    å°†è¿™ä¸ªæ€æƒ³åº”ç”¨åˆ°åŸºæ•°ä¼°è®¡ï¼šæˆ‘ä»¬å°†æ¯ä¸ªå…ƒç´ çš„å“ˆå¸Œå€¼è§†ä¸ºä¸€ä¸²éšæœºæ¯”ç‰¹ï¼Œç„¶åè§‚å¯Ÿè¿™äº›æ¯”ç‰¹ä¸²ä¸­ï¼š
                </p>
                <ul>
                    <li><strong>å‰å¯¼é›¶çš„æ•°é‡</strong> = è¿ç»­0çš„æ•°é‡</li>
                    <li><strong>æ¡¶ç¼–å·</strong> = å“ˆå¸Œå€¼çš„å‰å‡ ä½æ¯”ç‰¹</li>
                    <li><strong>å¯„å­˜å™¨</strong> = è®°å½•æ¯ä¸ªæ¡¶ä¸­è§‚å¯Ÿåˆ°çš„æœ€å¤§å‰å¯¼é›¶æ•°</li>
                </ul>
            </div>

            <div class="step-diagram">
                <div class="step-box">
                    <h4>1. å“ˆå¸Œ</h4>
                    <p>å…ƒç´  â†’ å“ˆå¸Œå€¼</p>
                    <div class="hash-demo">
å…ƒç´ : "apple"
å“ˆå¸Œ: 10110010...
                    </div>
                </div>
                <div class="arrow">â†’</div>
                <div class="step-box">
                    <h4>2. åˆ†æ¡¶</h4>
                    <p>å‰ p ä½ â†’ æ¡¶ç¼–å·</p>
                    <div class="hash-demo">
10110010...
^^^ (p=3ä½)
æ¡¶å·: 5 (101)
                    </div>
                </div>
                <div class="arrow">â†’</div>
                <div class="step-box">
                    <h4>3. è®¡æ•°</h4>
                    <p>å‰©ä½™ä½ â†’ å‰å¯¼é›¶</p>
                    <div class="hash-demo">
10010...
^^^
å‰å¯¼é›¶: 2ä¸ª
                    </div>
                </div>
                <div class="arrow">â†’</div>
                <div class="step-box">
                    <h4>4. æ›´æ–°</h4>
                    <p>å¯„å­˜å™¨[æ¡¶å·] = max(å½“å‰å€¼, å‰å¯¼é›¶)</p>
                </div>
            </div>

            <h2>æ•°å­¦åŸç†è¯¦è§£</h2>

            <h3>1. å“ˆå¸Œå‡½æ•°çš„ä½œç”¨</h3>
            <div class="algorithm-content">
                <p>
                    å“ˆå¸Œå‡½æ•°å°†ä»»æ„è¾“å…¥å‡åŒ€æ˜ å°„åˆ° [0, 2^64-1] åŒºé—´ï¼Œè¿™ä¿è¯äº†ï¼š
                </p>
                <ul>
                    <li>æ¯ä¸ªå…ƒç´ çš„å“ˆå¸Œå€¼æ˜¯ç‹¬ç«‹çš„</li>
                    <li>æ¯ä¸ªæ¯”ç‰¹ä½æ˜¯éšæœºçš„ï¼ˆ0æˆ–1çš„æ¦‚ç‡å„50%ï¼‰</li>
                    <li>ä¸åŒå…ƒç´ çš„å“ˆå¸Œå€¼å†²çªæ¦‚ç‡æä½</li>
                </ul>
            </div>

            <h3>2. æ¡¶çš„æ•°é‡ä¸ç²¾åº¦</h3>
            <div class="algorithm-content">
                <p>
                    å¦‚æœä½¿ç”¨ m = 2^p ä¸ªæ¡¶ï¼Œåˆ™ä¼°è®¡çš„æ ‡å‡†è¯¯å·®çº¦ä¸ºï¼š
                </p>
                <div class="math-formula">
                    <p>Standard Error (SE) â‰ˆ 1.04 / âˆšm</p>
                    <p>æˆ–è€…ç”¨æ¡¶æ•°è¡¨ç¤ºï¼šSE â‰ˆ 1.04 / 2^(p/2)</p>
                </div>
                <p>
                    <strong>å¸¸è§é…ç½®ï¼š</strong>
                </p>
                <table class="comparison-table">
                    <tr>
                        <th>æ¡¶æ•° (m)</th>
                        <th>ç²¾åº¦å‚æ•° (p)</th>
                        <th>æ ‡å‡†è¯¯å·®</th>
                        <th>å†…å­˜å ç”¨</th>
                    </tr>
                    <tr>
                        <td>2^10 = 1024</td>
                        <td>10</td>
                        <td>â‰ˆ 3.25%</td>
                        <td>~8 KB</td>
                    </tr>
                    <tr>
                        <td>2^12 = 4096</td>
                        <td>12</td>
                        <td>â‰ˆ 1.63%</td>
                        <td>~32 KB</td>
                    </tr>
                    <tr>
                        <td>2^14 = 16384</td>
                        <td>14</td>
                        <td>â‰ˆ 0.81%</td>
                        <td>~128 KB</td>
                    </tr>
                    <tr>
                        <td>2^16 = 65536</td>
                        <td>16</td>
                        <td>â‰ˆ 0.41%</td>
                        <td>~512 KB</td>
                    </tr>
                </table>
            </div>

            <h3>3. è°ƒå’Œå¹³å‡æ•°ï¼šæ ¸å¿ƒåˆ›æ–°</h3>
            <div class="principle-box">
                <h4>ä¸ºä»€ä¹ˆä¸ç”¨ç®—æœ¯å¹³å‡ï¼Ÿ</h4>
                <p>
                    å¦‚æœæˆ‘ä»¬ç›´æ¥å¯¹æ¯ä¸ªæ¡¶çš„æœ€å¤§å‰å¯¼é›¶å–å¹³å‡ï¼Œä¼šå—åˆ°å¼‚å¸¸å€¼çš„ä¸¥é‡å½±å“ã€‚
                    HyperLogLog çš„åˆ›æ–°åœ¨äºä½¿ç”¨<strong>è°ƒå’Œå¹³å‡æ•°</strong>ï¼š
                </p>
                <div class="math-formula">
                    <p>Harmonic Mean = m / Î£(1/xáµ¢)</p>
                    <p>å…¶ä¸­ xáµ¢ æ˜¯ç¬¬ i ä¸ªæ¡¶çš„ 2^Ráµ¢</p>
                </div>
                <p>
                    è°ƒå’Œå¹³å‡æ•°å¯¹å°å€¼æ›´æ•æ„Ÿï¼Œèƒ½æ›´å¥½åœ°å¤„ç†ç¨€ç–æ¡¶çš„æƒ…å†µã€‚
                </p>
            </div>

            <h3>4. å®Œæ•´çš„ä¼°è®¡å…¬å¼</h3>
            <div class="algorithm-content">
                <p>HyperLogLog çš„åŸºæ•°ä¼°è®¡å…¬å¼ï¼š</p>
                <div class="math-formula">
                    <p>Estimate = Î±â‚˜ Ã— mÂ² Ã— (Î£ 2^(-Ráµ¢))â»Â¹</p>
                    <br>
                    <p>å…¶ä¸­ï¼š</p>
                    <p>â€¢ Î±â‚˜ æ˜¯åå·®æ ¡æ­£ç³»æ•°</p>
                    <p>â€¢ m æ˜¯æ¡¶çš„æ•°é‡</p>
                    <p>â€¢ Ráµ¢ æ˜¯ç¬¬ i ä¸ªæ¡¶ä¸­è®°å½•çš„æœ€å¤§å‰å¯¼é›¶æ•°</p>
                </div>
                <p>
                    <strong>åå·®æ ¡æ­£ç³»æ•° Î±â‚˜ï¼š</strong>
                </p>
                <div class="math-formula">
                    <p>Î±â‚˜ = (0.7213 / (1 + 1.079/m))  å¯¹äº m â‰¥ 128</p>
                </div>
            </div>

            <h2>å¯„å­˜å™¨å¯è§†åŒ–</h2>
            <div class="algorithm-content">
                <p>
                    å‡è®¾æœ‰ 16 ä¸ªæ¡¶ (m=16, p=4)ï¼Œä¸‹é¢æ˜¯å¯èƒ½çš„å¯„å­˜å™¨çŠ¶æ€ï¼š
                </p>
                <div class="register-visual">
                    <div class="register highlight">Râ‚€: 3</div>
                    <div class="register">Râ‚: 5</div>
                    <div class="register">Râ‚‚: 2</div>
                    <div class="register">Râ‚ƒ: 4</div>
                    <div class="register">Râ‚„: 1</div>
                    <div class="register highlight">Râ‚…: 6</div>
                    <div class="register">Râ‚†: 3</div>
                    <div class="register">Râ‚‡: 4</div>
                    <div class="register">Râ‚ˆ: 2</div>
                    <div class="register">Râ‚‰: 3</div>
                    <div class="register">Râ‚â‚€: 5</div>
                    <div class="register">Râ‚â‚: 1</div>
                    <div class="register">Râ‚â‚‚: 4</div>
                    <div class="register highlight">Râ‚â‚ƒ: 7</div>
                    <div class="register">Râ‚â‚„: 2</div>
                    <div class="register">Râ‚â‚…: 3</div>
                </div>
                <p>
                    <span class="highlight-text">é«˜äº®</span>çš„å¯„å­˜å™¨è¡¨ç¤ºè§‚å¯Ÿåˆ°äº†è¾ƒå¤§çš„å‰å¯¼é›¶æ•°é‡ï¼Œæ„å‘³ç€å¯èƒ½æœ‰æ›´å¤šä¸åŒçš„å…ƒç´ ã€‚
                </p>
            </div>

            <h2>å®Œæ•´çš„ HyperLogLog å®ç°</h2>
            <div class="algorithm-content">
                <div class="code-tabs">
                    <div class="code-tab-header">
                        <button class="code-tab-btn active" data-tab="hll-js">JavaScript</button>
                        <button class="code-tab-btn" data-tab="hll-python">Python</button>
                        <button class="code-tab-btn" data-tab="hll-go">Go</button>
                    </div>
                    <div id="hll-js" class="code-tab-content active">
                        <div class="code-block line-numbers"><pre><code class="language-javascript">
class HyperLogLog {
    constructor(p = 14) {
        this.p = p;                    // ç²¾åº¦å‚æ•°
        this.m = 1 << p;               // æ¡¶çš„æ•°é‡ = 2^p
        this.registers = new Array(this.m).fill(0);
        this.alpha = this._getAlpha();
        this.count = 0;                // å®é™…æ’å…¥çš„å…ƒç´ æ•°ï¼ˆç”¨äºå°åŸºæ•°æ ¡æ­£ï¼‰
    }
    
    _getAlpha() {
        if (this.m >= 128) {
            return 0.7213 / (1 + 1.079 / this.m);
        }
        return 1.0; // å°è§„æ¨¡æ—¶çš„è¿‘ä¼¼å€¼
    }
    
    // MurmurHash3 çš„ç®€åŒ–ç‰ˆæœ¬
    _hash(value) {
        let h = 0x811c9dc5;
        const str = String(value);
        for (let i = 0; i < str.length; i++) {
            h ^= str.charCodeAt(i);
            h = Math.imul(h, 0x01000193);
        }
        return h >>> 0; // è½¬ä¸ºæ— ç¬¦å·æ•´æ•°
    }
    
    // æ·»åŠ ä¸€ä¸ªå…ƒç´ 
    add(value) {
        this.count++;
        
        const hash = this._hash(value);
        
        // æå–å‰ p ä½ä½œä¸ºæ¡¶ç¼–å·
        const bucket = hash & (this.m - 1);
        
        // è®¡ç®—å‰©ä½™æ¯”ç‰¹ä¸­å‰å¯¼é›¶çš„æ•°é‡
        // è·³è¿‡å‰ p ä½ï¼Œä»ç¬¬ p ä½å¼€å§‹
        const shifted = hash >>> this.p;
        const zeros = this._countLeadingZeros(shifted);
        
        // æ›´æ–°å¯„å­˜å™¨çš„æœ€å¤§å€¼
        this.registers[bucket] = Math.max(this.registers[bucket], zeros);
    }
    
    // è®¡ç®—å‰å¯¼é›¶çš„æ•°é‡
    _countLeadingZeros(value) {
        if (value === 0) return 32; // å‡è®¾32ä½æ•´æ•°
        let count = 0;
        while ((value & (1 << 31)) === 0 && count < 32) {
            count++;
            value <<= 1;
        }
        return count;
    }
    
    // ä¼°è®¡ä¸åŒå…ƒç´ çš„æ•°é‡
    countDistinct() {
        // å°åŸºæ•°æ ¡æ­£ï¼šå½“å®é™…å…ƒç´ æ•°å¾ˆå°æ—¶ï¼Œä½¿ç”¨ç²¾ç¡®è®¡æ•°
        if (this.count < this.m * 2.5) {
            return new Set(this.registers.filter(r => r > 0)).size;
        }
        
        // HyperLogLog ä¼°è®¡å…¬å¼
        let sum = 0;
        for (let i = 0; i < this.m; i++) {
            sum += 1 / (1 << this.registers[i]);
        }
        
        const estimate = this.alpha * this.m * this.m / sum;
        
        // ä¿®æ­£å°ä¼°è®¡å€¼
        return Math.floor(estimate);
    }
    
    // åˆå¹¶ä¸¤ä¸ª HyperLogLog
    merge(other) {
        if (this.m !== other.m) {
            throw new Error('Cannot merge HLL with different precision');
        }
        for (let i = 0; i < this.m; i++) {
            this.registers[i] = Math.max(this.registers[i], other.registers[i]);
        }
    }
}

// æµ‹è¯•
const hll = new HyperLogLog(12); // 4096 ä¸ªæ¡¶

// æ¨¡æ‹Ÿæ’å…¥ 100000 ä¸ªä¸åŒçš„å…ƒç´ 
for (let i = 0; i < 100000; i++) {
    hll.add(`element_${i}_${Math.random()}`);
}

console.log(`å®é™…ä¸åŒå…ƒç´ æ•°: 100000`);
console.log(`HLL ä¼°è®¡å€¼: ${hll.countDistinct()}`);
console.log(`è¯¯å·®ç‡: ${Math.abs(hll.countDistinct() - 100000) / 100000 * 100}%`);
                            </code></pre></div>
                    </div>
                    <div id="hll-python" class="code-tab-content">
                        <div class="code-block line-numbers"><pre><code class="language-python">
import math
import random

class HyperLogLog:
    def __init__(self, p=14):
        self.p = p                    # ç²¾åº¦å‚æ•°
        self.m = 1 << p               # æ¡¶çš„æ•°é‡ = 2^p
        self.registers = [0] * self.m
        self.alpha = self._get_alpha()
        self.count = 0                # å®é™…æ’å…¥çš„å…ƒç´ æ•°ï¼ˆç”¨äºå°åŸºæ•°æ ¡æ­£ï¼‰
    
    def _get_alpha(self):
        if self.m >= 128:
            return 0.7213 / (1 + 1.079 / self.m)
        return 1.0  # å°è§„æ¨¡æ—¶çš„è¿‘ä¼¼å€¼
    
    # MurmurHash3 çš„ç®€åŒ–ç‰ˆæœ¬
    def _hash(self, value):
        h = 0x811c9dc5
        string = str(value)
        for char in string:
            h ^= ord(char)
            h = (h * 0x01000193) & 0xFFFFFFFF
        return h
    
    # æ·»åŠ ä¸€ä¸ªå…ƒç´ 
    def add(self, value):
        self.count += 1
        
        hash_val = self._hash(value)
        
        # æå–å‰ p ä½ä½œä¸ºæ¡¶ç¼–å·
        bucket = hash_val & (self.m - 1)
        
        # è®¡ç®—å‰©ä½™æ¯”ç‰¹ä¸­å‰å¯¼é›¶çš„æ•°é‡
        shifted = hash_val >> self.p
        zeros = self._count_leading_zeros(shifted)
        
        # æ›´æ–°å¯„å­˜å™¨çš„æœ€å¤§å€¼
        self.registers[bucket] = max(self.registers[bucket], zeros)
    
    # è®¡ç®—å‰å¯¼é›¶çš„æ•°é‡
    def _count_leading_zeros(self, value):
        if value == 0:
            return 32  # å‡è®¾32ä½æ•´æ•°
        count = 0
        while (value & 0x80000000) == 0 and count < 32:
            count += 1
            value <<= 1
        return count
    
    # ä¼°è®¡ä¸åŒå…ƒç´ çš„æ•°é‡
    def count_distinct(self):
        # å°åŸºæ•°æ ¡æ­£ï¼šå½“å®é™…å…ƒç´ æ•°å¾ˆå°æ—¶ï¼Œä½¿ç”¨ç²¾ç¡®è®¡æ•°
        if self.count < self.m * 2.5:
            return len(set(self.registers))
        
        # HyperLogLog ä¼°è®¡å…¬å¼
        sum_val = 0
        for reg in self.registers:
            sum_val += 1 / (1 << reg)
        
        estimate = self.alpha * self.m * self.m / sum_val
        
        # ä¿®æ­£å°ä¼°è®¡å€¼
        return int(estimate)
    
    # åˆå¹¶ä¸¤ä¸ª HyperLogLog
    def merge(self, other):
        if self.m != other.m:
            raise ValueError('Cannot merge HLL with different precision')
        for i in range(self.m):
            self.registers[i] = max(self.registers[i], other.registers[i])

# æµ‹è¯•
if __name__ == "__main__":
    hll = HyperLogLog(p=12)  # 4096 ä¸ªæ¡¶
    
    # æ¨¡æ‹Ÿæ’å…¥ 100000 ä¸ªä¸åŒçš„å…ƒç´ 
    for i in range(100000):
        hll.add(f"element_{i}_{random.random()}")
    
    print(f"å®é™…ä¸åŒå…ƒç´ æ•°: 100000")
    print(f"HLL ä¼°è®¡å€¼: {hll.count_distinct()}")
    print(f"è¯¯å·®ç‡: {abs(hll.count_distinct() - 100000) / 100000 * 100}%")
                            </code></pre></div>
                    </div>
                    <div id="hll-go" class="code-tab-content">
                        <div class="code-block line-numbers"><pre><code class="language-go">
package main

import (
    "fmt"
    "math"
    "math/rand"
)

type HyperLogLog struct {
    p         int
    m         int
    registers []int
    alpha     float64
    count     int
}

func NewHyperLogLog(p int) *HyperLogLog {
    m := 1 << p
    hll := &HyperLogLog{
        p:         p,
        m:         m,
        registers: make([]int, m),
        count:     0,
    }
    hll.alpha = hll.getAlpha()
    return hll
}

func (h *HyperLogLog) getAlpha() float64 {
    if h.m >= 128 {
        return 0.7213 / (1 + 1.079/float64(h.m))
    }
    return 1.0
}

// MurmurHash3 çš„ç®€åŒ–ç‰ˆæœ¬
func (h *HyperLogLog) hash(value string) uint32 {
    var hVal uint32 = 0x811c9dc5
    for i := 0; i < len(value); i++ {
        hVal ^= uint32(value[i])
        hVal = (hVal * 0x01000193) & 0xFFFFFFFF
    }
    return hVal
}

// æ·»åŠ ä¸€ä¸ªå…ƒç´ 
func (h *HyperLogLog) Add(value string) {
    h.count++

    hashVal := h.hash(value)

    // æå–å‰ p ä½ä½œä¸ºæ¡¶ç¼–å·
    bucket := int(hashVal & uint32(h.m-1))

    // è®¡ç®—å‰©ä½™æ¯”ç‰¹ä¸­å‰å¯¼é›¶çš„æ•°é‡
    shifted := hashVal >> uint(h.p)
    zeros := h.countLeadingZeros(shifted)

    // æ›´æ–°å¯„å­˜å™¨çš„æœ€å¤§å€¼
    if zeros > h.registers[bucket] {
        h.registers[bucket] = zeros
    }
}

// è®¡ç®—å‰å¯¼é›¶çš„æ•°é‡
func (h *HyperLogLog) countLeadingZeros(value uint32) int {
    if value == 0 {
        return 32
    }
    count := 0
    for (value&0x80000000) == 0 && count < 32 {
        count++
        value <<= 1
    }
    return count
}

// ä¼°è®¡ä¸åŒå…ƒç´ çš„æ•°é‡
func (h *HyperLogLog) CountDistinct() int {
    // å°åŸºæ•°æ ¡æ­£ï¼šå½“å®é™…å…ƒç´ æ•°å¾ˆå°æ—¶ï¼Œä½¿ç”¨ç²¾ç¡®è®¡æ•°
    if h.count < h.m*5/2 {
        unique := make(map[int]bool)
        for _, r := range h.registers {
            if r > 0 {
                unique[r] = true
            }
        }
        return len(unique)
    }

    // HyperLogLog ä¼°è®¡å…¬å¼
    var sum float64
    for _, reg := range h.registers {
        sum += 1 / math.Pow(2, float64(reg))
    }

    estimate := h.alpha * float64(h.m) * float64(h.m) / sum

    // ä¿®æ­£å°ä¼°è®¡å€¼
    return int(estimate)
}

// åˆå¹¶ä¸¤ä¸ª HyperLogLog
func (h *HyperLogLog) Merge(other *HyperLogLog) {
    if h.m != other.m {
        panic("Cannot merge HLL with different precision")
    }
    for i := 0; i < h.m; i++ {
        if other.registers[i] > h.registers[i] {
            h.registers[i] = other.registers[i]
        }
    }
}

func main() {
    hll := NewHyperLogLog(12) // 4096 ä¸ªæ¡¶

    // æ¨¡æ‹Ÿæ’å…¥ 100000 ä¸ªä¸åŒçš„å…ƒç´ 
    for i := 0; i < 100000; i++ {
        hll.Add(fmt.Sprintf("element_%d_%f", i, rand.Float64()))
    }

    fmt.Printf("å®é™…ä¸åŒå…ƒç´ æ•°: 100000\n")
    fmt.Printf("HLL ä¼°è®¡å€¼: %d\n", hll.CountDistinct())
    diff := float64(hll.CountDistinct() - 100000)
    fmt.Printf("è¯¯å·®ç‡: %.2f%%\n", math.Abs(diff)/100000*100)
}
                            </code></pre></div>
                    </div>
                </div>
            </div>

            <h2>ä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”</h2>
            <table class="comparison-table">
                <tr>
                    <th>æ–¹æ¡ˆ</th>
                    <th>ç©ºé—´å¤æ‚åº¦</th>
                    <th>ç²¾åº¦</th>
                    <th>ä¼˜ç‚¹</th>
                    <th>ç¼ºç‚¹</th>
                </tr>
                <tr>
                    <td>ç²¾ç¡®è®¡æ•° (Set)</td>
                    <td>O(n)</td>
                    <td>100%</td>
                    <td>ç²¾ç¡®</td>
                    <td>å†…å­˜éš n å¢é•¿</td>
                </tr>
                <tr>
                    <td>LogLog</td>
                    <td>O(1)</td>
                    <td>â‰ˆ 1.3 / âˆšm</td>
                    <td>ç©ºé—´å°</td>
                    <td>ç²¾åº¦ç•¥ä½</td>
                </tr>
                <tr>
                    <td><strong>HyperLogLog</strong></td>
                    <td>O(1)</td>
                    <td>â‰ˆ 1.04 / âˆšm</td>
                    <td>ç²¾åº¦é«˜ã€ç©ºé—´å°</td>
                    <td>æ¦‚ç‡æ€§ã€æœ‰å°åå·®</td>
                </tr>
                <tr>
                    <td>Count-Min Sketch</td>
                    <td>O(1)</td>
                    <td>å¯é…ç½®</td>
                    <td>æ”¯æŒåˆ é™¤</td>
                    <td>éœ€è¦æ›´å¤šç©ºé—´</td>
                </tr>
            </table>

            <h2>å®é™…åº”ç”¨åœºæ™¯</h2>
            <div class="algorithm-content">
                <h3>1. æ•°æ®åº“å»é‡è®¡æ•°</h3>
                <p>
                    Redis çš„ <code>PFCOUNT</code> å‘½ä»¤åº•å±‚å°±æ˜¯ HyperLogLogï¼Œç”¨äºå¿«é€Ÿè®¡ç®— UVï¼ˆç‹¬ç«‹è®¿å®¢æ•°ï¼‰ã€‚
                </p>
                
                <h3>2. å®æ—¶æ•°æ®åˆ†æ</h3>
                <p>
                    åœ¨æµå¤„ç†ç³»ç»Ÿä¸­ï¼Œéœ€è¦å®æ—¶ä¼°è®¡ä¸åŒç”¨æˆ·æ•°ã€é¡µé¢è®¿é—®é‡ç­‰ï¼ŒHLL æ˜¯ç†æƒ³é€‰æ‹©ã€‚
                </p>
                
                <h3>3. ç½‘ç»œå®‰å…¨</h3>
                <p>
                    æ£€æµ‹ç½‘ç»œæ”»å‡»æ—¶ï¼Œä¼°è®¡ä¸åŒ IP åœ°å€çš„æ•°é‡ï¼ŒHLL å¯ä»¥åœ¨æœ‰é™å†…å­˜ä¸‹å¤„ç†æµ·é‡æ•°æ®ã€‚
                </p>
                
                <h3>4. æ¨èç³»ç»Ÿ</h3>
                <p>
                    ä¼°è®¡ä¸åŒç”¨æˆ·å¯¹æŸä¸ªå†…å®¹çš„äº¤äº’æ•°é‡ï¼Œç”¨äºè®¡ç®—çƒ­åº¦ã€ç›¸å…³æ€§ç­‰æŒ‡æ ‡ã€‚
                </p>
            </div>

            <h2>HyperLogLog çš„å˜ä½“</h2>
            <div class="algorithm-content">
                <h3>1. HyperLogLog++</h3>
                <p>
                    Google åœ¨ 2013 å¹´æå‡ºçš„æ”¹è¿›ç‰ˆï¼Œä¸»è¦ä¼˜åŒ–äº†ï¼š
                </p>
                <ul>
                    <li>å°åŸºæ•°æ—¶çš„ç²¾åº¦ï¼ˆä½¿ç”¨ç¨€ç–å­˜å‚¨ï¼‰</li>
                    <li>æ›´å¥½çš„åå·®æ ¡æ­£</li>
                    <li>è¢« Redis 6.0+ é‡‡ç”¨</li>
                </ul>
                
                <h3>2. Linear Counting</h3>
                <p>
                    å½“åŸºæ•°è¾ƒå°æ—¶ï¼ˆå°äº m Ã— 10ï¼‰ï¼Œä½¿ç”¨çº¿æ€§è®¡æ•°ä»£æ›¿ HLL ä¼°è®¡ï¼Œå¯æé«˜å°åŸºæ•°æ—¶çš„ç²¾åº¦ã€‚
                </p>
                
                <h3>3. Redis å®ç°</h3>
                <div class="code-block line-numbers"><pre><code class="language-javascript">
// Redis å‘½ä»¤ç¤ºä¾‹
PFADD mykey "user1" "user2" "user3"  // æ·»åŠ å…ƒç´ 
PFCOUNT mykey                           // ä¼°è®¡åŸºæ•°
PFMERGE mergedkey key1 key2             // åˆå¹¶ä¸¤ä¸ª HLL
                    </code></pre></div>
            </div>

            <h2>æ€»ç»“ï¼šä¸ºä»€ä¹ˆ HyperLogLog æœ‰æ•ˆï¼Ÿ</h2>
            <div class="principle-box">
                <h4>æ ¸å¿ƒæ´å¯Ÿ</h4>
                <ol>
                    <li><strong>æ¦‚ç‡è®ºåŸºç¡€</strong>ï¼šè§‚å¯Ÿåˆ° k ä¸ªå‰å¯¼é›¶çš„æ¦‚ç‡æ˜¯ 2^(-k)ï¼Œè¿™æä¾›äº†åŸºæ•°çš„å¯¹æ•°ä¼°è®¡</li>
                    <li><strong>å¤šæ¡¶å¹³å‡</strong>ï¼šä½¿ç”¨å¤šä¸ªç‹¬ç«‹ä¼°è®¡ï¼ˆæ¡¶ï¼‰ï¼Œç„¶åå–è°ƒå’Œå¹³å‡ï¼Œå¤§å¤§é™ä½äº†æ–¹å·®</li>
                    <li><strong>åå·®æ ¡æ­£</strong>ï¼šé€šè¿‡ç†è®ºå’Œå®éªŒç¡®å®šçš„ç³»æ•° Î±â‚˜ ä¿®æ­£ç³»ç»Ÿæ€§åå·®</li>
                    <li><strong>å›ºå®šç©ºé—´</strong>ï¼šæ¡¶çš„æ•°é‡å›ºå®šï¼Œå†…å­˜ä½¿ç”¨ä¸åŸºæ•°å¤§å°æ— å…³</li>
                </ol>
            </div>

            <h3>å­¦ä¹ å»ºè®®</h3>
            <div class="algorithm-content">
                <ul>
                    <li>å…ˆç†è§£æ¦‚ç‡è®ºä¸­çš„ä¼¯åŠªåˆ©è¯•éªŒå’Œå‡ ä½•åˆ†å¸ƒ</li>
                    <li>ç†è§£ä¸ºä»€ä¹ˆè°ƒå’Œå¹³å‡æ•°æ¯”ç®—æœ¯å¹³å‡æ•°æ›´é€‚åˆ</li>
                    <li>æ‰‹åŠ¨å®ç°ç®€åŒ–ç‰ˆçš„ HyperLogLog æ¥åŠ æ·±ç†è§£</li>
                    <li>ç ”ç©¶ Redis æˆ–å…¶ä»–ç³»ç»Ÿçš„å®é™…å®ç°</li>
                    <li>äº†è§£ HyperLogLog++ å’Œå…¶ä»–æ”¹è¿›ç‰ˆæœ¬</li>
                </ul>
            </div>
        </div>
    </section>

    <script src="../js/main.js"></script>
    <script src="../lib/prism/prism.min.js"></script>
    <script src="../lib/prism/prism-python.min.js"></script>
    <script src="../lib/prism/prism-go.min.js"></script>
    <script src="../lib/prism/prism-line-numbers.min.js"></script>
</body>
</html>